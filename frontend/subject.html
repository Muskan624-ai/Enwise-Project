<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject - ENWISE</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="enhanced-styles.css">
</head>
<body class="subject-page">
    <div class="container">
        <!-- Header -->
        <header class="header">
            <a href="index.html" class="logo">
                <span class="logo-text">EnWise</span>
            </a>
            <nav class="nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="#aiTutorSection" class="nav-link" onclick="scrollToAITutor(event)">AI-Tutor</a>
            </nav>
            <button class="profile-btn">Student profile</button>
            
            <!-- Hamburger Menu -->
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </header>

        <!-- Mobile Navigation Overlay -->
        <div class="nav-overlay" id="navOverlay"></div>
        
        <!-- Mobile Navigation -->
        <nav class="nav-mobile" id="navMobile">
            <a href="index.html" class="nav-link">Home</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="#aiTutorSection" class="nav-link" onclick="scrollToAITutor(event)">AI-Tutor</a>
            <button class="profile-btn">Student profile</button>
        </nav>

        <!-- Subject Page Content -->
        <main class="subject-page-main">
            <h1 class="subject-title" id="subjectTitle">Subject Name</h1>

            <div class="subject-layout">
                <!-- Left Sidebar -->
                <div class="left-sidebar">
                    <!-- Syllabus Card with Modules -->
                    <div class="sidebar-card-expanded" id="syllabusCard">
                        <h3>Syllabus</h3>
                        <input type="file" id="syllabusInput" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx" style="display: none;">
                        <div class="module-list" id="syllabusList">
                            <!-- Modules will be added here -->
                        </div>
                        <button class="add-module-btn" id="addSyllabusModule">+</button>
                    </div>
                    
                    <!-- ClassNotes Card with Subtopics -->
                    <div class="sidebar-card-expanded" id="classNotesCard">
                        <h3>ClassNotes</h3>
                        <input type="file" id="classNotesInput" accept=".pdf,.doc,.docx,.txt,.jpg,.png,.ppt,.pptx" multiple style="display: none;">
                        <div class="module-list" id="notesList">
                            <!-- Subtopics will be added here -->
                        </div>
                        <button class="add-module-btn" id="addNotesSubtopic">+</button>
                    </div>
                    
                    <div class="sidebar-card" id="timetableCard">
                        <h3>Timetable</h3>
                        <span class="add-icon">+</span>
                        <input type="file" id="timetableInput" accept=".pdf,.doc,.docx,.txt,.jpg,.png,.xlsx,.csv" style="display: none;">
                        <div class="uploaded-file" id="timetableFile"></div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="main-content-area">
                    <!-- Quiz Levels Card -->
                    <div class="content-card quiz-levels-card">
                        <h3>üìù Practice Quizzes</h3>
                        <p style="margin-bottom: 1rem; color: #888;">Select difficulty level to test your knowledge</p>
                        <div class="quiz-levels-container">
                            <button class="quiz-level-btn level-1" onclick="generateLevelQuiz(1)">
                                <span class="level-icon">üå±</span>
                                <span class="level-text">
                                    <strong>Level 1</strong>
                                    <small>Basics & Fundamentals</small>
                                </span>
                            </button>
                            <button class="quiz-level-btn level-2" onclick="generateLevelQuiz(2)">
                                <span class="level-icon">üåø</span>
                                <span class="level-text">
                                    <strong>Level 2</strong>
                                    <small>Intermediate Concepts</small>
                                </span>
                            </button>
                            <button class="quiz-level-btn level-3" onclick="generateLevelQuiz(3)">
                                <span class="level-icon">üå≥</span>
                                <span class="level-text">
                                    <strong>Level 3</strong>
                                    <small>Advanced & Application</small>
                                </span>
                            </button>
                        </div>
                    </div>

                    <div class="content-card ai-tutor-card" id="aiTutorSection">
                        <h3>AI Tutor - Your Complete Study Companion</h3>
                        <p>
                            <strong>Get comprehensive help with:</strong><br>
                            üìö Theory explanations with real-life analogies<br>
                            üî¢ Step-by-step numerical problem solutions<br>
                            üí° Practical examples and applications<br>
                            üìù Practice problems and quiz preparation<br>
                            üéØ Personalized study strategies<br>
                            üåç <strong>Multilingual support</strong> - Ask in any language!
                        </p>
                        <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                            Ask anything from basic concepts to complex calculations!
                        </p>
                        
                        <!-- Chat Messages Container -->
                        <div class="chat-messages" id="chatMessages">
                            <div class="ai-message">
                                <span class="message-avatar">ü§ñ</span>
                                <div class="message-content">
                                    Hi! I'm your AI Tutor. Ask me anything about <strong id="chatSubjectName">any subject</strong> or any educational topic. I can explain in multiple languages too! üåç
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Input inside AI Tutor -->
                        <div class="chat-input-container">
                            <button class="attachment-btn" title="Attach file">üìé</button>
                            <input type="text" class="chat-input" placeholder="Ask anything - theory, numericals, examples... (any language)" id="chatInput">
                            <button class="send-btn" id="sendBtn" title="Send">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - MindMap -->
                <div class="right-sidebar">
                    <h3 class="mindmap-title">MindMap</h3>
                
                    <div class="topic-list" id="topicList">
                        <div class="topic-item no-topics-placeholder" id="noTopicsMsg">
                            <span style="color: #888; font-style: italic; font-size: 0.9rem;">üìù Complete a quiz to see your weak topics here!</span>
                        </div>
                    </div>

                    <!-- PYQs Section -->
                    <div class="pyqs-section">
                        <h3 class="pyqs-title">üìö PYQs (Previous Year Questions)</h3>
                        <div class="pyqs-upload-area" id="pyqsUploadArea">
                            <input type="file" id="pyqsInput" accept=".pdf,.doc,.docx,.txt,.jpg,.png" multiple style="display: none;">
                            <span class="pyqs-icon">üìÑ</span>
                            <p>Upload PYQ Papers</p>
                            <span class="pyqs-hint">PDF, DOC, Images</span>
                        </div>
                        <div class="pyqs-list" id="pyqsList">
                            <!-- Uploaded PYQs will appear here -->
                        </div>
                        <button class="practice-pyqs-btn" id="practicePyqsBtn" style="display: none;">
                            üéØ Practice PYQs
                        </button>
                    </div>

                    <!-- Course Timeline Section -->
                    <div class="timeline-section">
                        <h3 class="timeline-title">üìÖ Course Timeline</h3>
                        
                        <div class="timeline-motivation" id="timelineMotivation">
                            <strong>Time to regain momentum!</strong>
                            <p>You're behind schedule. Let's focus on one small achievable step you can take today to start catching up. You can do it!</p>
                        </div>
                        
                        <div class="timeline-container">
                            <div class="timeline-item start-date">
                                <span class="timeline-icon">üìç</span>
                                <div class="timeline-content">
                                    <span class="timeline-label">Start date:</span>
                                    <span class="timeline-value" id="startDate">Not set</span>
                                    <button class="set-date-btn" id="setStartDateBtn">Set</button>
                                </div>
                            </div>
                            
                            <div class="timeline-line"></div>
                            
                            <div class="timeline-deadlines" id="deadlinesList">
                                <p class="timeline-sublabel">Your next deadlines</p>
                                <!-- Deadlines will be added here -->
                            </div>
                            
                            <div class="timeline-line"></div>
                            
                            <div class="timeline-item end-date">
                                <span class="timeline-icon">üèÅ</span>
                                <div class="timeline-content">
                                    <span class="timeline-label">Estimated end date:</span>
                                    <span class="timeline-value" id="endDate">Not set</span>
                                    <button class="set-date-btn" id="setEndDateBtn">Set</button>
                                </div>
                            </div>
                        </div>
                        
                        <button class="add-deadline-btn" id="addDeadlineBtn">+ Add Deadline</button>
                    </div>
                    
                </div>
            </div>
        </main>
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay" style="display: none;">
        <div class="processing-modal">
            <div class="processing-icon">ü§ñ</div>
            <h3 id="processingTitle">AI is analyzing your file...</h3>
            <p id="processingFile"></p>
            <div class="loading-dots" id="loadingDots">
                <span></span><span></span><span></span>
            </div>
            <p class="processing-note">Generating prerequisite quiz based on topics...</p>
            <button id="openQuizBtn" class="open-quiz-btn" style="display: none;">üìù Open Quiz</button>
        </div>
    </div>

    <style>
        /* Quiz Level Buttons Styles */
        .quiz-levels-card {
            background: linear-gradient(135deg, #1a2a3a 0%, #2d3e50 100%);
            border-radius: 16px;
            padding: 1.5rem;
        }
        .quiz-levels-card h3 {
            color: #5fc4b8;
            margin-bottom: 0.5rem;
        }
        .quiz-levels-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .quiz-level-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        .quiz-level-btn .level-icon {
            font-size: 1.8rem;
        }
        .quiz-level-btn .level-text {
            display: flex;
            flex-direction: column;
        }
        .quiz-level-btn .level-text strong {
            font-size: 1.1rem;
            margin-bottom: 2px;
        }
        .quiz-level-btn .level-text small {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .quiz-level-btn.level-1 {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: #052e16;
        }
        .quiz-level-btn.level-1:hover {
            transform: translateX(8px);
            box-shadow: 0 4px 20px rgba(74, 222, 128, 0.4);
        }
        .quiz-level-btn.level-2 {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #451a03;
        }
        .quiz-level-btn.level-2:hover {
            transform: translateX(8px);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4);
        }
        .quiz-level-btn.level-3 {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: #450a0a;
        }
        .quiz-level-btn.level-3:hover {
            transform: translateX(8px);
            box-shadow: 0 4px 20px rgba(248, 113, 113, 0.4);
        }

        /* Expanded Sidebar Cards - Syllabus & ClassNotes */
        .sidebar-card-expanded {
            background: #e8f5e9;
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #a5d6a7;
        }
        .sidebar-card-expanded h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.8rem;
        }
        .module-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .module-item {
            background: white;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e0e0e0;
        }
        .module-item:hover {
            background: #f5f5f5;
            border-color: #2d8a6e;
        }
        .module-item.has-file {
            border-left: 3px solid #2d8a6e;
        }
        .module-item .module-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .module-item .module-actions {
            display: flex;
            gap: 0.3rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .module-item:hover .module-actions {
            opacity: 1;
        }
        .module-item .module-action {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.2rem;
        }
        .add-module-btn {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background: transparent;
            border: 2px dashed #a5d6a7;
            border-radius: 20px;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .add-module-btn:hover {
            background: white;
            border-color: #2d8a6e;
            color: #2d8a6e;
        }
        
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .processing-modal {
            background: white;
            padding: 2rem 3rem;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
        }
        .processing-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .processing-modal h3 {
            color: #2d8a6e;
            margin-bottom: 0.5rem;
        }
        .processing-modal p {
            color: #666;
            margin-bottom: 1rem;
        }
        .processing-note {
            color: #999 !important;
            font-size: 0.85rem;
        }
        .loading-dots {
            display: flex;
            justify-content: center;
            gap: 0.3rem;
            margin: 1rem 0;
        }
        .loading-dots span {
            width: 10px;
            height: 10px;
            background: #2d8a6e;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .open-quiz-btn {
            background: #2d8a6e;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }
        .open-quiz-btn:hover {
            background: #1f6b54;
        }
        
        /* Chat Messages Styles */
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin: 1rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        .ai-message, .user-message {
            display: flex;
            gap: 0.5rem;
            max-width: 90%;
        }
        .ai-message {
            align-self: flex-start;
        }
        .user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-avatar {
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .message-content {
            padding: 0.8rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        .ai-message .message-content {
            background: white;
            border: 1px solid #e0e0e0;
            border-top-left-radius: 4px;
        }
        .user-message .message-content {
            background: #2d8a6e;
            color: white;
            border-top-right-radius: 4px;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 0.8rem 1rem;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #2d8a6e;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-5px); opacity: 1; }
        }
        .message-content pre {
            background: #263238;
            color: #aed581;
            padding: 0.8rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 0.5rem 0;
            font-size: 0.85rem;
        }
        .message-content code {
            background: #e8f5e9;
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        /* PYQs Section Styles */
        .pyqs-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px dashed #e0e0e0;
        }
        .pyqs-title {
            font-size: 1rem;
            color: #333;
            margin-bottom: 1rem;
        }
        .pyqs-upload-area {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pyqs-upload-area:hover {
            border-color: #2d8a6e;
            background: #e8f5e9;
        }
        .pyqs-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.5rem;
        }
        .pyqs-upload-area p {
            margin: 0;
            font-weight: 500;
            color: #333;
        }
        .pyqs-hint {
            font-size: 0.75rem;
            color: #999;
        }
        .pyqs-list {
            margin-top: 0.8rem;
        }
        .pyq-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
            border: 1px solid #e0e0e0;
        }
        .pyq-item .pyq-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .pyq-item .pyq-remove {
            color: #d32f2f;
            cursor: pointer;
            font-weight: bold;
        }
        .practice-pyqs-btn {
            width: 100%;
            margin-top: 1rem;
            padding: 0.8rem;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .practice-pyqs-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,152,0,0.4);
        }
        
        /* Course Timeline Styles */
        .timeline-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px dashed #e0e0e0;
        }
        .timeline-title {
            font-size: 1rem;
            color: #333;
            margin-bottom: 1rem;
        }
        .timeline-motivation {
            background: #fff8e1;
            border-left: 4px solid #ff9800;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 1rem;
        }
        .timeline-motivation strong {
            color: #e65100;
            display: block;
            margin-bottom: 0.3rem;
        }
        .timeline-motivation p {
            color: #666;
            font-size: 0.85rem;
            margin: 0;
            line-height: 1.4;
        }
        .timeline-container {
            position: relative;
            padding-left: 1.5rem;
        }
        .timeline-line {
            position: absolute;
            left: 0.6rem;
            top: 2rem;
            bottom: 2rem;
            width: 2px;
            background: repeating-linear-gradient(
                to bottom,
                #ccc 0px,
                #ccc 5px,
                transparent 5px,
                transparent 10px
            );
        }
        .timeline-item {
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .timeline-icon {
            font-size: 1.2rem;
            background: white;
            z-index: 1;
        }
        .timeline-content {
            flex: 1;
        }
        .timeline-label {
            font-size: 0.85rem;
            color: #666;
            display: block;
        }
        .timeline-value {
            font-weight: 600;
            color: #333;
            display: block;
            margin-top: 0.2rem;
        }
        .set-date-btn {
            background: #e8f5e9;
            color: #2d8a6e;
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 0.3rem;
        }
        .timeline-sublabel {
            font-size: 0.8rem;
            color: #999;
            margin: 0.5rem 0;
        }
        .timeline-deadlines {
            margin: 1rem 0;
            padding-left: 2rem;
        }
        .deadline-item {
            background: white;
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.6rem;
            border: 1px solid #e0e0e0;
        }
        .deadline-item .deadline-name {
            font-weight: 500;
            color: #333;
            font-size: 0.9rem;
        }
        .deadline-item .deadline-status {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        .deadline-status.overdue {
            background: #ffebee;
            color: #c62828;
        }
        .deadline-status.due-soon {
            background: #fff8e1;
            color: #f57c00;
        }
        .deadline-status.completed {
            background: #e8f5e9;
            color: #2d8a6e;
        }
        .deadline-type {
            font-size: 0.75rem;
            color: #666;
            background: #f5f5f5;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        .add-deadline-btn {
            width: 100%;
            padding: 0.6rem;
            background: transparent;
            border: 2px dashed #ccc;
            border-radius: 8px;
            color: #666;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .add-deadline-btn:hover {
            border-color: #2d8a6e;
            color: #2d8a6e;
        }
        
        /* Custom Checkbox Styles */
        .topic-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        .topic-checkbox:checked {
            background: #2d8a6e;
            border-color: #2d8a6e;
        }
        .topic-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        .topic-checkbox:hover {
            border-color: #2d8a6e;
        }
    </style>

    <script src="script.js"></script>
    <script>
        // Backend API Configuration
        const API_BASE_URL = 'http://localhost:8000'; // FastAPI backend on port 8000
        
        // Get subject name from URL parameter
        var urlParams = new URLSearchParams(window.location.search);
        var currentSubject = urlParams.get('subject') || 'New Subject';
        document.getElementById('subjectTitle').textContent = currentSubject;

        // Variables to track uploads
        var syllabusUploaded = false;
        var notesUploaded = false;
        var pendingQuizSource = null;

        // ========== Syllabus Modules & ClassNotes Subtopics Logic ==========
        var syllabusModules = JSON.parse(localStorage.getItem('syllabus_' + currentSubject) || '[]');
        var notesSubtopics = JSON.parse(localStorage.getItem('notes_' + currentSubject) || '[]');
        var currentUploadTarget = null; // Track which module/subtopic is being uploaded to

        // Initialize modules/subtopics
        function initModulesAndNotes() {
            renderSyllabusModules();
            renderNotesSubtopics();
        }

        function renderSyllabusModules() {
            var list = document.getElementById('syllabusList');
            if (syllabusModules.length === 0) {
                list.innerHTML = '<p style="font-size:0.8rem;color:#999;text-align:center;">Click + to add modules</p>';
            } else {
                var html = '';
                syllabusModules.forEach(function(mod, idx) {
                    html += '<div class="module-item ' + (mod.file ? 'has-file' : '') + '" data-idx="' + idx + '" data-type="syllabus">' +
                        '<span class="module-name">' + mod.name + '</span>' +
                        '<span class="module-actions">' +
                        '<button class="module-action upload-btn" title="Upload file">üìé</button>' +
                        '<button class="module-action delete-btn" title="Delete">‚úï</button>' +
                        '</span></div>';
                });
                list.innerHTML = html;
                attachModuleListeners('syllabus');
            }
            syllabusUploaded = syllabusModules.some(function(m) { return m.file; });
        }

        function renderNotesSubtopics() {
            var list = document.getElementById('notesList');
            if (notesSubtopics.length === 0) {
                list.innerHTML = '<p style="font-size:0.8rem;color:#999;text-align:center;">Click + to add subtopics</p>';
            } else {
                var html = '';
                notesSubtopics.forEach(function(note, idx) {
                    html += '<div class="module-item ' + (note.file ? 'has-file' : '') + '" data-idx="' + idx + '" data-type="notes">' +
                        '<span class="module-name">' + note.name + '</span>' +
                        '<span class="module-actions">' +
                        '<button class="module-action upload-btn" title="Upload file">üìé</button>' +
                        '<button class="module-action delete-btn" title="Delete">‚úï</button>' +
                        '</span></div>';
                });
                list.innerHTML = html;
                attachModuleListeners('notes');
            }
            notesUploaded = notesSubtopics.some(function(n) { return n.file; });
        }

        function attachModuleListeners(type) {
            var selector = type === 'syllabus' ? '#syllabusList' : '#notesList';
            
            document.querySelectorAll(selector + ' .upload-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var idx = parseInt(this.closest('.module-item').getAttribute('data-idx'));
                    currentUploadTarget = { type: type, idx: idx };
                    if (type === 'syllabus') {
                        document.getElementById('syllabusInput').click();
                    } else {
                        document.getElementById('classNotesInput').click();
                    }
                });
            });
            
            document.querySelectorAll(selector + ' .delete-btn').forEach(function(btn) {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    var idx = parseInt(this.closest('.module-item').getAttribute('data-idx'));
                    if (type === 'syllabus') {
                        // Delete file from IndexedDB if exists
                        if (syllabusModules[idx].fileId) {
                            await deleteFile(syllabusModules[idx].fileId);
                        }
                        syllabusModules.splice(idx, 1);
                        localStorage.setItem('syllabus_' + currentSubject, JSON.stringify(syllabusModules));
                        renderSyllabusModules();
                    } else {
                        // Delete file from IndexedDB if exists
                        if (notesSubtopics[idx].fileId) {
                            await deleteFile(notesSubtopics[idx].fileId);
                        }
                        notesSubtopics.splice(idx, 1);
                        localStorage.setItem('notes_' + currentSubject, JSON.stringify(notesSubtopics));
                        renderNotesSubtopics();
                    }
                });
            });
            
            // Click on module to generate quiz from that file
            document.querySelectorAll(selector + ' .module-item').forEach(function(item) {
                item.addEventListener('click', async function(e) {
                    if (e.target.classList.contains('module-action')) return;
                    
                    var idx = parseInt(this.getAttribute('data-idx'));
                    var moduleData = type === 'syllabus' ? syllabusModules[idx] : notesSubtopics[idx];
                    
                    if (!moduleData.fileId) {
                        alert('No file uploaded for this ' + (type === 'syllabus' ? 'module' : 'subtopic') + '. Click üìé to upload.');
                        return;
                    }
                    
                    // Get stored file and generate quiz
                    var storedFile = await getFile(moduleData.fileId);
                    if (storedFile) {
                        // Create a File object from stored data
                        var blob = new Blob([storedFile.data], { type: storedFile.type });
                        var file = new File([blob], storedFile.name, { type: storedFile.type });
                        
                        // Show processing overlay
                        var overlay = document.getElementById('processingOverlay');
                        document.getElementById('processingTitle').textContent = 'Generating Quiz from ' + moduleData.name;
                        document.getElementById('processingFile').textContent = '"' + storedFile.name + '"';
                        document.getElementById('openQuizBtn').style.display = 'none';
                        document.getElementById('loadingDots').style.display = 'flex';
                        overlay.style.display = 'flex';
                        
                        // Create input-like object for handleFileSelect
                        var fakeInput = { files: [file] };
                        await handleFileSelect(fakeInput, moduleData.name, type);
                    }
                });
            });
        }

        // Add Module button
        document.getElementById('addSyllabusModule').addEventListener('click', function() {
            var name = prompt('Enter module name (e.g., Module 1: Introduction):');
            if (name && name.trim()) {
                syllabusModules.push({ name: name.trim(), file: null });
                localStorage.setItem('syllabus_' + currentSubject, JSON.stringify(syllabusModules));
                renderSyllabusModules();
            }
        });

        // Add Subtopic button
        document.getElementById('addNotesSubtopic').addEventListener('click', function() {
            var name = prompt('Enter subtopic name (e.g., Subtopic 1: Basics):');
            if (name && name.trim()) {
                notesSubtopics.push({ name: name.trim(), file: null });
                localStorage.setItem('notes_' + currentSubject, JSON.stringify(notesSubtopics));
                renderNotesSubtopics();
            }
        });

        // Initialize on load
        initModulesAndNotes();
        
        // Setup file upload click handlers (for timetable only now)
        document.getElementById('timetableCard').addEventListener('click', function(e) {
            if (e.target.tagName !== 'INPUT') {
                document.getElementById('timetableInput').click();
            }
        });

        // ========== IndexedDB for storing PDF files ==========
        var dbName = 'EnwiseFilesDB';
        var dbVersion = 1;
        var db = null;

        function initDB() {
            return new Promise(function(resolve, reject) {
                var request = indexedDB.open(dbName, dbVersion);
                
                request.onerror = function() {
                    console.error('IndexedDB error');
                    reject();
                };
                
                request.onsuccess = function(e) {
                    db = e.target.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = function(e) {
                    var database = e.target.result;
                    if (!database.objectStoreNames.contains('files')) {
                        database.createObjectStore('files', { keyPath: 'id' });
                    }
                };
            });
        }

        function storeFile(fileId, file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var transaction = db.transaction(['files'], 'readwrite');
                    var store = transaction.objectStore('files');
                    
                    var fileData = {
                        id: fileId,
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result, // ArrayBuffer
                        uploadedAt: new Date().toISOString()
                    };
                    
                    var request = store.put(fileData);
                    request.onsuccess = function() { resolve(fileData); };
                    request.onerror = function() { reject(); };
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function getFile(fileId) {
            return new Promise(function(resolve, reject) {
                var transaction = db.transaction(['files'], 'readonly');
                var store = transaction.objectStore('files');
                var request = store.get(fileId);
                
                request.onsuccess = function(e) { resolve(e.target.result); };
                request.onerror = function() { reject(); };
            });
        }

        function deleteFile(fileId) {
            return new Promise(function(resolve, reject) {
                var transaction = db.transaction(['files'], 'readwrite');
                var store = transaction.objectStore('files');
                var request = store.delete(fileId);
                
                request.onsuccess = function() { resolve(); };
                request.onerror = function() { reject(); };
            });
        }

        // Initialize IndexedDB
        initDB().then(function() {
            console.log('‚úÖ IndexedDB initialized for file storage');
        });

        // File input change handlers
        document.getElementById('syllabusInput').addEventListener('change', function() {
            handleSyllabusUpload(this);
        });
        
        document.getElementById('classNotesInput').addEventListener('change', function() {
            handleClassNotesUpload(this);
        });
        
        document.getElementById('timetableInput').addEventListener('change', function() {
            handleTimetableUpload(this);
        });

        async function handleSyllabusUpload(input) {
            if (input.files && input.files.length > 0) {
                var file = input.files[0];
                var fileName = file.name;
                
                // Update module with file info and store file
                if (currentUploadTarget && currentUploadTarget.type === 'syllabus') {
                    var idx = currentUploadTarget.idx;
                    var fileId = 'syllabus_' + currentSubject + '_' + idx;
                    
                    // Store file in IndexedDB
                    try {
                        await storeFile(fileId, file);
                        syllabusModules[idx].file = fileName;
                        syllabusModules[idx].fileId = fileId;
                        localStorage.setItem('syllabus_' + currentSubject, JSON.stringify(syllabusModules));
                        renderSyllabusModules();
                        showNotification('üìÑ File "' + fileName + '" saved to ' + syllabusModules[idx].name, 'success');
                    } catch(e) {
                        console.error('File storage error:', e);
                    }
                    currentUploadTarget = null;
                } else {
                    // Direct upload without module - create a new module
                    var moduleName = 'Module ' + (syllabusModules.length + 1);
                    var fileId = 'syllabus_' + currentSubject + '_' + syllabusModules.length;
                    
                    try {
                        await storeFile(fileId, file);
                        syllabusModules.push({ name: moduleName, file: fileName, fileId: fileId });
                        localStorage.setItem('syllabus_' + currentSubject, JSON.stringify(syllabusModules));
                        renderSyllabusModules();
                    } catch(e) {
                        console.error('File storage error:', e);
                    }
                }
                
                syllabusUploaded = true;
                
                // Send to backend and generate quiz
                await handleFileSelect(input, 'Syllabus', 'syllabus');
            }
        }

        async function handleClassNotesUpload(input) {
            if (input.files && input.files.length > 0) {
                var file = input.files[0];
                var fileName = file.name;
                
                // Update subtopic with file info and store file
                if (currentUploadTarget && currentUploadTarget.type === 'notes') {
                    var idx = currentUploadTarget.idx;
                    var fileId = 'notes_' + currentSubject + '_' + idx;
                    
                    // Store file in IndexedDB
                    try {
                        await storeFile(fileId, file);
                        notesSubtopics[idx].file = fileName;
                        notesSubtopics[idx].fileId = fileId;
                        localStorage.setItem('notes_' + currentSubject, JSON.stringify(notesSubtopics));
                        renderNotesSubtopics();
                        showNotification('üìù File "' + fileName + '" saved to ' + notesSubtopics[idx].name, 'success');
                    } catch(e) {
                        console.error('File storage error:', e);
                    }
                    currentUploadTarget = null;
                } else {
                    // Direct upload without subtopic - create a new subtopic
                    var subtopicName = 'Subtopic ' + (notesSubtopics.length + 1);
                    var fileId = 'notes_' + currentSubject + '_' + notesSubtopics.length;
                    
                    try {
                        await storeFile(fileId, file);
                        notesSubtopics.push({ name: subtopicName, file: fileName, fileId: fileId });
                        localStorage.setItem('notes_' + currentSubject, JSON.stringify(notesSubtopics));
                        renderNotesSubtopics();
                    } catch(e) {
                        console.error('File storage error:', e);
                    }
                }
                
                notesUploaded = true;
                
                // Send to backend and generate quiz
                await handleFileSelect(input, 'Notes', 'notes');
            }
        }

        function handleTimetableUpload(input) {
            if (input.files && input.files.length > 0) {
                var file = input.files[0];
                var fileName = file.name;
                
                // Store timetable file
                storeFile('timetable_' + currentSubject, file).then(function() {
                    showNotification('üìÖ Timetable saved!', 'success');
                });
                
                document.getElementById('timetableFile').innerHTML = '<span class="file-name">üìÖ ' + fileName + '</span>';
                
                var addIcon = document.querySelector('#timetableCard .add-icon');
                addIcon.textContent = '‚úì';
                addIcon.style.color = '#2d8a6e';
                
                alert('Timetable "' + fileName + '" uploaded successfully!');
            }
        }

        // Main file upload handler with backend integration
        async function handleFileSelect(input, type, sourceType) {
            const file = input.files[0];
            if (!file) return;

            // 1. Visual feedback for the user
            console.log('Uploading ' + type + ': ' + file.name);
            const overlay = document.getElementById('processingOverlay');
            if (overlay) {
                document.getElementById('processingTitle').textContent = 'AI is analyzing your ' + type + '...';
                document.getElementById('processingFile').textContent = '"' + file.name + '"';
                document.getElementById('openQuizBtn').style.display = 'none';
                document.getElementById('loadingDots').style.display = 'flex';
                overlay.style.display = 'flex';
            }

            // 2. Prepare the "Parcel" for the backend
            const formData = new FormData();
            formData.append("file", file);
            formData.append("subject", currentSubject);
            formData.append("chapter", type);

            try {
                // 3. Send to your Python backend
                const response = await fetch(API_BASE_URL + '/generate-offline-pack', {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) throw new Error("Backend failed");

                const data = await response.json();

                // 4. Store the AI's Quiz and Summary in the browser memory
                // Format: quiz should be an array of objects with { q: question, options: [], a: answer }
                if (data.quiz && Array.isArray(data.quiz.questions)) {
                    // Backend format conversion
                    const formattedQuiz = data.quiz.questions.map(q => ({
                        q: q.question,
                        options: q.options,
                        a: q.options[q.correct] || q.answer || q.correct_answer
                    }));
                    localStorage.setItem('latest_quiz_data', JSON.stringify(formattedQuiz));
                } else if (Array.isArray(data.quiz)) {
                    // If already in correct format
                    localStorage.setItem('latest_quiz_data', JSON.stringify(data.quiz));
                } else {
                    console.warn('Quiz data format unexpected, using fallback');
                    localStorage.setItem('latest_quiz_data', JSON.stringify([]));
                }
                
                localStorage.setItem('latest_summary_data', JSON.stringify(data.summary || {}));

                // 5. Update UI: Change '+' to '‚úì'
                const addIcon = input.parentElement.querySelector('.add-icon');
                if (addIcon) {
                    addIcon.textContent = "‚úì";
                    addIcon.style.color = "#2d8a6e";
                }

                // 6. Auto-open quiz immediately
                document.getElementById('processingTitle').textContent = "Opening Quiz...";
                document.getElementById('processingFile').textContent = 'Quiz generated successfully!';
                document.getElementById('loadingDots').style.display = "none";
                
                pendingQuizSource = sourceType;
                
                // Open quiz automatically after small delay
                setTimeout(() => {
                    openQuizInNewTab(sourceType);
                }, 500);

            } catch (error) {
                console.error("Upload error:", error);
                
                // Check if it's a rate limit error
                let errorMessage = 'Backend offline - using smart fallback';
                let titleMessage = 'Generating Local Quiz...';
                
                if (error.message && error.message.includes('429')) {
                    errorMessage = 'API rate limit reached (20/day). Using local quiz.';
                    titleMessage = 'Rate Limit - Using Fallback...';
                }
                
                console.log("‚ö†Ô∏è Backend unavailable - using local quiz generation");
                
                // Update overlay to show fallback mode
                if (overlay) {
                    document.getElementById('processingTitle').textContent = titleMessage;
                    document.getElementById('processingFile').textContent = errorMessage;
                }
                
                // Still mark as uploaded (fallback to local quiz generation)
                const addIcon = input.parentElement.querySelector('.add-icon');
                if (addIcon) {
                    addIcon.textContent = "‚úì";
                    addIcon.style.color = "#2d8a6e";
                }
                
                // Generate a simple fallback quiz after short delay
                setTimeout(() => {
                    generateFallbackQuiz(sourceType);
                }, 800);
            }
        }

        // Fallback quiz generation for when backend is unavailable
        function generateFallbackQuiz(sourceType) {
            const fallbackQuiz = [
                {
                    q: "What is the fundamental concept in " + currentSubject + "?",
                    options: ["Basic principles", "Advanced theories", "Applied methods", "Historical context"],
                    a: "Basic principles"
                },
                {
                    q: "Which prerequisite knowledge is essential for " + currentSubject + "?",
                    options: ["Foundation concepts", "Expert level skills", "Research experience", "Industry practice"],
                    a: "Foundation concepts"
                },
                {
                    q: "What approach is recommended for learning " + currentSubject + "?",
                    options: ["Step-by-step progression", "Random exploration", "Skip basics", "Memorization only"],
                    a: "Step-by-step progression"
                },
                {
                    q: "How would you describe the difficulty level of " + currentSubject + "?",
                    options: ["Requires systematic study", "Very simple", "Impossible to learn", "No preparation needed"],
                    a: "Requires systematic study"
                },
                {
                    q: "What is the best way to practice " + currentSubject + "?",
                    options: ["Regular problem solving", "Occasional reading", "Avoid practice", "Theory only"],
                    a: "Regular problem solving"
                }
            ];
            
            localStorage.setItem('latest_quiz_data', JSON.stringify(fallbackQuiz));
            localStorage.setItem('latest_summary_data', JSON.stringify({
                topics: [currentSubject + " basics"],
                source: sourceType,
                mode: "local"
            }));
            
            // Update overlay to show ready state
            const overlay = document.getElementById('processingOverlay');
            if (overlay) {
                document.getElementById('processingTitle').textContent = "Quiz Ready!";
                document.getElementById('processingFile').textContent = '5 prerequisite questions generated';
                document.getElementById('loadingDots').style.display = "none";
                document.getElementById('openQuizBtn').style.display = "block";
                
                // Store the source type for opening later
                pendingQuizSource = sourceType;
            }
        }

        function openQuizInNewTab(sourceType) {
            var quizUrl = 'quiz.html?subject=' + encodeURIComponent(currentSubject) + '&source=' + sourceType;
            var quizWindow = window.open(quizUrl, '_blank');
            
            // Check if popup was blocked
            if (!quizWindow || quizWindow.closed || typeof quizWindow.closed === 'undefined') {
                // Show manual button
                document.getElementById('processingTitle').textContent = 'Quiz Ready!';
                document.getElementById('processingFile').textContent = 'Click below to open the quiz';
                document.getElementById('loadingDots').style.display = 'none';
                document.getElementById('openQuizBtn').style.display = 'inline-block';
            } else {
                // Close overlay
                document.getElementById('processingOverlay').style.display = 'none';
            }
        }

        // Generate quiz based on level (1=Easy, 2=Medium, 3=Hard)
        function generateLevelQuiz(level) {
            var levelNames = {1: 'easy', 2: 'medium', 3: 'hard'};
            var levelLabels = {1: 'Basics & Fundamentals', 2: 'Intermediate Concepts', 3: 'Advanced & Application'};
            
            // Check if any content is uploaded
            if (!syllabusUploaded && !notesUploaded) {
                alert('Please upload Syllabus or Class Notes first to generate a quiz!');
                return;
            }
            
            // Show processing overlay
            var overlay = document.getElementById('processingOverlay');
            document.getElementById('processingTitle').textContent = 'Generating Level ' + level + ' Quiz...';
            document.getElementById('processingFile').textContent = levelLabels[level];
            document.getElementById('openQuizBtn').style.display = 'none';
            document.getElementById('loadingDots').style.display = 'flex';
            overlay.style.display = 'flex';
            
            // Determine source
            var sourceType = syllabusUploaded ? 'syllabus' : 'notes';
            
            // Open quiz with level parameter
            var quizUrl = 'quiz.html?subject=' + encodeURIComponent(currentSubject) + 
                          '&source=' + sourceType + 
                          '&level=' + level +
                          '&difficulty=' + levelNames[level];
            
            var quizWindow = window.open(quizUrl, '_blank');
            
            if (!quizWindow || quizWindow.closed) {
                document.getElementById('processingTitle').textContent = 'Level ' + level + ' Quiz Ready!';
                document.getElementById('processingFile').textContent = 'Click below to open';
                document.getElementById('loadingDots').style.display = 'none';
                document.getElementById('openQuizBtn').style.display = 'inline-block';
                document.getElementById('openQuizBtn').onclick = function() {
                    window.open(quizUrl, '_blank');
                    overlay.style.display = 'none';
                };
            } else {
                overlay.style.display = 'none';
            }
        }

        // Manual quiz open button
        document.getElementById('openQuizBtn').addEventListener('click', function() {
            var quizUrl = 'quiz.html?subject=' + encodeURIComponent(currentSubject) + '&source=' + pendingQuizSource;
            window.open(quizUrl, '_blank');
            document.getElementById('processingOverlay').style.display = 'none';
            document.getElementById('loadingDots').style.display = 'flex';
        });

        // Generate Quiz button
        document.getElementById('generateQuizBtn').addEventListener('click', function() {
            if (!syllabusUploaded && !notesUploaded) {
                alert('Please upload a Syllabus or Class Notes first to generate a quiz.');
                return;
            }
            
            var sourceType = syllabusUploaded ? 'syllabus' : 'notes';
            openQuizInNewTab(sourceType);
        });

        // Listen for quiz results from popup
        window.addEventListener('message', function(e) {
            if (e.data && e.data.weakTopics) {
                var weakTopics = e.data.weakTopics;
                var score = e.data.score || 0;
                var subject = e.data.subject || currentSubject;
                
                console.log('üì¨ Received quiz results:', { weakTopics, score, subject });
                
                // Add weak topics to MindMap
                weakTopics.forEach(function(topic) {
                    addWeakTopicToMindMap(topic);
                });
                
                // Show notification
                if (weakTopics.length > 0) {
                    showNotification('Quiz Complete! Score: ' + score + '%. ' + weakTopics.length + ' weak topics added to MindMap.', 'warning');
                } else {
                    showNotification('Perfect Score: ' + score + '%! All topics mastered.', 'success');
                }
                
                // Close the processing overlay if still open
                document.getElementById('processingOverlay').style.display = 'none';
            }
        });
        
        // Simple notification function
        function showNotification(message, type) {
            var notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.innerHTML = message;
            notification.style.cssText = 'position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:10px;color:white;font-weight:500;z-index:10000;animation:slideIn 0.3s ease;';
            notification.style.background = type === 'success' ? '#2d8a6e' : '#ff9800';
            document.body.appendChild(notification);
            
            setTimeout(function() {
                notification.style.opacity = '0';
                setTimeout(function() { notification.remove(); }, 300);
            }, 4000);
        }

        function addWeakTopicToMindMap(topicName) {
            var topicList = document.getElementById('topicList');
            if (!topicList) return;
            
            // Hide the "no topics" placeholder
            var placeholder = document.getElementById('noTopicsMsg');
            if (placeholder) placeholder.style.display = 'none';
            
            // Check if topic already exists
            var existingLabels = topicList.querySelectorAll('.topic-label');
            for (var i = 0; i < existingLabels.length; i++) {
                if (existingLabels[i].textContent.includes(topicName)) {
                    console.log('Topic already exists:', topicName);
                    return; // Don't add duplicate
                }
            }
            
            var newTopic = document.createElement('div');
            newTopic.className = 'topic-item';
            var safeId = 'weak_' + topicName.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
            newTopic.innerHTML = '<input type="checkbox" class="topic-checkbox" id="' + safeId + '">' +
                '<label class="topic-label" for="' + safeId + '" style="color: #d32f2f;">‚ö†Ô∏è ' + topicName + '</label>';
            topicList.insertBefore(newTopic, topicList.firstChild);
            
            // Re-attach checkbox listener
            var checkbox = newTopic.querySelector('.topic-checkbox');
            checkbox.addEventListener('click', function(e) {
                if (!this.checked) return;
                e.preventDefault();
                var label = this.nextElementSibling.textContent;
                var confirmed = confirm('AI Question: Before marking "' + label + '" as complete, please answer a fundamental question about this topic.\n\nDo you want to proceed with the question?');
                if (confirmed) {
                    alert('Question would appear here. For now, marking as complete.');
                    this.checked = true;
                    this.nextElementSibling.style.color = '#2d8a6e';
                    this.nextElementSibling.style.textDecoration = 'line-through';
                }
            });
        }
        
        // Load existing weak topics from localStorage on page load
        function loadSavedWeakTopics() {
            var savedTopics = localStorage.getItem('weak_topics_' + currentSubject);
            console.log('üìö Loading weak topics for', currentSubject, ':', savedTopics);
            
            if (savedTopics) {
                try {
                    var topics = JSON.parse(savedTopics);
                    if (topics && topics.length > 0) {
                        // Hide the placeholder message
                        var placeholder = document.getElementById('noTopicsMsg');
                        if (placeholder) placeholder.style.display = 'none';
                        
                        topics.forEach(function(topic) {
                            addWeakTopicToMindMap(topic);
                        });
                    }
                } catch(e) {
                    console.error('Error loading saved weak topics:', e);
                }
            }
        }
        
        // Load saved topics when page loads
        loadSavedWeakTopics();
        
        // Reload weak topics when user comes back to this tab (after completing quiz)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('üîÑ Tab visible - checking for new weak topics');
                loadSavedWeakTopics();
            }
        });

        // Send message function
        document.getElementById('sendBtn').addEventListener('click', function() {
            sendMessage();
        });

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Update chat subject name
        document.getElementById('chatSubjectName').textContent = currentSubject;

        async function sendMessage() {
            var input = document.getElementById('chatInput');
            var message = input.value.trim();
            if (!message) return;
            
            var chatMessages = document.getElementById('chatMessages');
            
            // Add user message to chat
            var userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'user-message';
            userMsgDiv.innerHTML = '<span class="message-avatar">üë§</span><div class="message-content">' + escapeHtml(message) + '</div>';
            chatMessages.appendChild(userMsgDiv);
            
            // Clear input
            input.value = '';
            
            // Add typing indicator
            var typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = '<span class="message-avatar">ü§ñ</span><div class="typing-indicator"><span></span><span></span><span></span></div>';
            chatMessages.appendChild(typingDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                // Call AI backend
                var response = await fetch(API_BASE_URL + '/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        subject: currentSubject,
                        language: 'auto',
                        context: localStorage.getItem('latest_summary_data') || ''
                    })
                });
                
                // Remove typing indicator
                var typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
                
                if (!response.ok) throw new Error('AI request failed');
                
                var data = await response.json();
                var aiResponse = data.response || 'Sorry, I could not process that.';
                
                // Add AI response
                var aiMsgDiv = document.createElement('div');
                aiMsgDiv.className = 'ai-message';
                aiMsgDiv.innerHTML = '<span class="message-avatar">ü§ñ</span><div class="message-content">' + formatAIResponse(aiResponse) + '</div>';
                chatMessages.appendChild(aiMsgDiv);
                
            } catch (error) {
                console.error('Chat error:', error);
                
                // Remove typing indicator
                var typing = document.getElementById('typingIndicator');
                if (typing) typing.remove();
                
                // Show error message
                var errorDiv = document.createElement('div');
                errorDiv.className = 'ai-message';
                errorDiv.innerHTML = '<span class="message-avatar">ü§ñ</span><div class="message-content" style="color:#d32f2f;">‚ö†Ô∏è Could not connect to AI. Please make sure the backend server is running on port 8000.</div>';
                chatMessages.appendChild(errorDiv);
            }
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatAIResponse(text) {
            // Convert markdown-style formatting to HTML
            var formatted = escapeHtml(text);
            
            // Bold: **text** or __text__
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // Italic: *text* or _text_
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Code blocks: ```code```
            formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
            
            // Inline code: `code`
            formatted = formatted.replace(/`(.*?)`/g, '<code>$1</code>');
            
            // Line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        // Checkbox confirmation logic
        document.querySelectorAll('.topic-checkbox').forEach(function(checkbox) {
            checkbox.addEventListener('change', function(e) {
                var checkboxEl = this;
                var topicName = this.nextElementSibling.textContent;
                
                if (this.checked) {
                    // Immediately uncheck - we'll check it after confirmation
                    this.checked = false;
                    
                    var confirmed = confirm('AI Question: Before marking "' + topicName + '" as complete, please answer a fundamental question about this topic.\n\nDo you want to proceed with the question?');
                    
                    if (confirmed) {
                        // Simulate AI asking a question
                        var answer = prompt('Quick Question: What is the most important concept you learned about "' + topicName + '"?');
                        
                        if (answer && answer.trim().length > 5) {
                            checkboxEl.checked = true;
                            checkboxEl.nextElementSibling.style.textDecoration = 'line-through';
                            checkboxEl.nextElementSibling.style.color = '#2d8a6e';
                            
                            // Save completed topic
                            var completedTopics = JSON.parse(localStorage.getItem('completed_topics_' + currentSubject) || '[]');
                            if (!completedTopics.includes(topicName)) {
                                completedTopics.push(topicName);
                                localStorage.setItem('completed_topics_' + currentSubject, JSON.stringify(completedTopics));
                            }
                            
                            showNotification('‚úÖ Topic "' + topicName + '" marked as complete!', 'success');
                        } else {
                            alert('Please provide a more detailed answer to mark this topic as complete.');
                        }
                    }
                }
            });
        });

        // ========== PYQs Section Logic ==========
        var pyqsUploadArea = document.getElementById('pyqsUploadArea');
        var pyqsInput = document.getElementById('pyqsInput');
        var pyqsList = document.getElementById('pyqsList');
        var practicePyqsBtn = document.getElementById('practicePyqsBtn');
        var uploadedPyqs = [];

        // Load saved PYQs for this subject
        function loadSavedPyqs() {
            var saved = localStorage.getItem('pyqs_' + currentSubject);
            if (saved) {
                uploadedPyqs = JSON.parse(saved);
                renderPyqsList();
            }
        }

        // Click to upload
        pyqsUploadArea.addEventListener('click', function() {
            pyqsInput.click();
        });

        // Handle file selection
        pyqsInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                for (var i = 0; i < this.files.length; i++) {
                    var file = this.files[i];
                    uploadedPyqs.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploadedAt: new Date().toISOString()
                    });
                }
                // Save to localStorage
                localStorage.setItem('pyqs_' + currentSubject, JSON.stringify(uploadedPyqs));
                renderPyqsList();
            }
        });

        // Render the PYQs list
        function renderPyqsList() {
            if (uploadedPyqs.length === 0) {
                pyqsList.innerHTML = '';
                practicePyqsBtn.style.display = 'none';
                return;
            }

            var html = '';
            uploadedPyqs.forEach(function(pyq, index) {
                html += '<div class="pyq-item">' +
                    '<span>üìÑ</span>' +
                    '<span class="pyq-name">' + pyq.name + '</span>' +
                    '<span class="pyq-remove" data-index="' + index + '">‚úï</span>' +
                    '</div>';
            });
            pyqsList.innerHTML = html;
            practicePyqsBtn.style.display = 'block';

            // Add remove listeners
            document.querySelectorAll('.pyq-remove').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var idx = parseInt(this.getAttribute('data-index'));
                    uploadedPyqs.splice(idx, 1);
                    localStorage.setItem('pyqs_' + currentSubject, JSON.stringify(uploadedPyqs));
                    renderPyqsList();
                });
            });
        }

        // Practice PYQs button - Generate quiz from PYQs
        practicePyqsBtn.addEventListener('click', async function() {
            // Get the file input to re-upload for processing
            var pyqFileInput = document.getElementById('pyqsInput');
            
            if (!pyqFileInput.files || pyqFileInput.files.length === 0) {
                // If no files in input, ask to re-upload
                alert('Please upload a PYQ file again to generate practice questions.');
                pyqFileInput.click();
                return;
            }
            
            var file = pyqFileInput.files[0];
            
            // Show processing overlay
            var overlay = document.getElementById('processingOverlay');
            document.getElementById('processingTitle').textContent = 'Analyzing PYQ Patterns...';
            document.getElementById('processingFile').textContent = '"' + file.name + '"';
            document.getElementById('openQuizBtn').style.display = 'none';
            document.getElementById('loadingDots').style.display = 'flex';
            document.querySelector('.processing-note').textContent = 'Generating practice questions from PYQ patterns...';
            overlay.style.display = 'flex';
            
            // Prepare form data
            var formData = new FormData();
            formData.append('file', file);
            formData.append('subject', currentSubject);
            formData.append('num_questions', '5');
            
            try {
                var response = await fetch(API_BASE_URL + '/generate-pyq-quiz', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('PYQ processing failed');
                
                var data = await response.json();
                
                // Format quiz data for quiz.html
                var quizData = data.quiz.map(function(q) {
                    return {
                        q: q.q,
                        options: q.options,
                        a: q.a,
                        explanation: q.explanation || ''
                    };
                });
                
                // Store quiz data
                localStorage.setItem('latest_quiz_data', JSON.stringify(quizData));
                localStorage.setItem('pyq_topics_found', JSON.stringify(data.topics_found || []));
                localStorage.setItem('latest_summary_data', JSON.stringify({
                    topics: data.topics_found,
                    difficulty: data.difficulty,
                    source: 'pyq',
                    mode: 'pyq-practice'
                }));
                
                // Update overlay
                document.getElementById('processingTitle').textContent = 'PYQ Quiz Ready!';
                document.getElementById('processingFile').textContent = 'Topics: ' + (data.topics_found || []).slice(0, 3).join(', ');
                document.getElementById('loadingDots').style.display = 'none';
                
                // Open quiz
                setTimeout(function() {
                    var quizUrl = 'quiz.html?subject=' + encodeURIComponent(currentSubject) + '&source=pyq';
                    window.open(quizUrl, '_blank');
                    overlay.style.display = 'none';
                }, 500);
                
            } catch (error) {
                console.error('PYQ Error:', error);
                overlay.style.display = 'none';
                alert('‚ùå Could not generate PYQ quiz. Make sure the backend is running and try again.');
            }
        });

        // Load saved PYQs on page load
        loadSavedPyqs();

        // ========== Course Timeline Logic ==========
        var timelineData = JSON.parse(localStorage.getItem('timeline_' + currentSubject) || '{"startDate": null, "endDate": null, "deadlines": []}');

        // Initialize timeline
        function initTimeline() {
            renderStartDate();
            renderEndDate();
            renderDeadlines();
            updateMotivation();
        }

        function renderStartDate() {
            var startDateEl = document.getElementById('startDate');
            if (timelineData.startDate) {
                startDateEl.textContent = formatDate(timelineData.startDate);
            } else {
                startDateEl.textContent = 'Not set';
            }
        }

        function renderEndDate() {
            var endDateEl = document.getElementById('endDate');
            if (timelineData.endDate) {
                endDateEl.textContent = formatDate(timelineData.endDate);
            } else {
                endDateEl.textContent = 'Not set';
            }
        }

        function renderDeadlines() {
            var deadlinesList = document.getElementById('deadlinesList');
            var html = '<p class="timeline-sublabel">Your next deadlines</p>';
            
            if (timelineData.deadlines.length === 0) {
                html += '<p style="font-size: 0.8rem; color: #999;">No deadlines set</p>';
            } else {
                // Sort by date
                var sortedDeadlines = timelineData.deadlines.slice().sort(function(a, b) {
                    return new Date(a.date) - new Date(b.date);
                });
                
                sortedDeadlines.forEach(function(deadline, idx) {
                    var status = getDeadlineStatus(deadline.date, deadline.completed);
                    html += '<div class="deadline-item">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                        '<span class="deadline-name">' + deadline.name + '</span>' +
                        '<span class="deadline-remove" data-idx="' + idx + '" style="cursor:pointer;color:#d32f2f;">‚úï</span>' +
                        '</div>' +
                        '<div style="margin-top: 0.4rem;">' +
                        '<span class="deadline-status ' + status.class + '">' + status.text + '</span>' +
                        '<span class="deadline-type">' + (deadline.type || 'Assignment') + '</span>' +
                        '</div>' +
                        '</div>';
                });
            }
            
            deadlinesList.innerHTML = html;
            
            // Add remove listeners
            document.querySelectorAll('.deadline-remove').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var idx = parseInt(this.getAttribute('data-idx'));
                    timelineData.deadlines.splice(idx, 1);
                    saveTimeline();
                    renderDeadlines();
                    updateMotivation();
                });
            });
        }

        function getDeadlineStatus(dateStr, completed) {
            if (completed) {
                return { text: 'Completed', class: 'completed' };
            }
            var now = new Date();
            var deadline = new Date(dateStr);
            var diffDays = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return { text: 'Overdue', class: 'overdue' };
            } else if (diffDays <= 3) {
                return { text: 'Due in ' + diffDays + ' day' + (diffDays !== 1 ? 's' : ''), class: 'due-soon' };
            } else {
                return { text: 'Due in ' + diffDays + ' days', class: 'due-soon' };
            }
        }

        function updateMotivation() {
            var motivationEl = document.getElementById('timelineMotivation');
            var overdueCount = timelineData.deadlines.filter(function(d) {
                return !d.completed && new Date(d.date) < new Date();
            }).length;
            
            if (overdueCount > 0) {
                motivationEl.innerHTML = '<strong>Time to regain momentum!</strong>' +
                    '<p>You have ' + overdueCount + ' overdue deadline(s). Let\'s focus on one small achievable step you can take today. You can do it!</p>';
                motivationEl.style.background = '#fff8e1';
                motivationEl.style.borderLeftColor = '#ff9800';
            } else if (timelineData.deadlines.length > 0) {
                motivationEl.innerHTML = '<strong>Great progress!</strong>' +
                    '<p>You\'re on track! Keep up the good work and stay consistent with your study schedule.</p>';
                motivationEl.style.background = '#e8f5e9';
                motivationEl.style.borderLeftColor = '#2d8a6e';
            } else {
                motivationEl.innerHTML = '<strong>Set your goals!</strong>' +
                    '<p>Add deadlines and dates to track your progress and stay motivated throughout your learning journey.</p>';
                motivationEl.style.background = '#e3f2fd';
                motivationEl.style.borderLeftColor = '#1976d2';
            }
        }

        function formatDate(dateStr) {
            var date = new Date(dateStr);
            var options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function saveTimeline() {
            localStorage.setItem('timeline_' + currentSubject, JSON.stringify(timelineData));
        }

        // Set Start Date
        document.getElementById('setStartDateBtn').addEventListener('click', function() {
            var dateInput = prompt('Enter start date (YYYY-MM-DD):');
            if (dateInput && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                timelineData.startDate = dateInput;
                saveTimeline();
                renderStartDate();
            } else if (dateInput) {
                alert('Please use format YYYY-MM-DD (e.g., 2025-10-23)');
            }
        });

        // Set End Date
        document.getElementById('setEndDateBtn').addEventListener('click', function() {
            var dateInput = prompt('Enter estimated end date (YYYY-MM-DD):');
            if (dateInput && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
                timelineData.endDate = dateInput;
                saveTimeline();
                renderEndDate();
            } else if (dateInput) {
                alert('Please use format YYYY-MM-DD (e.g., 2026-02-05)');
            }
        });

        // Add Deadline
        document.getElementById('addDeadlineBtn').addEventListener('click', function() {
            var name = prompt('Deadline name (e.g., Module Quiz: Introduction):');
            if (!name) return;
            
            var date = prompt('Due date (YYYY-MM-DD):');
            if (!date || !/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                alert('Please use format YYYY-MM-DD');
                return;
            }
            
            var type = prompt('Type (Quiz, Assignment, Exam, Project):') || 'Assignment';
            
            timelineData.deadlines.push({
                name: name,
                date: date,
                type: type,
                completed: false
            });
            
            saveTimeline();
            renderDeadlines();
            updateMotivation();
        });

        // Initialize timeline on load
        initTimeline();

        // Scroll to AI Tutor section
        function scrollToAITutor(event) {
            event.preventDefault();
            var aiSection = document.getElementById('aiTutorSection');
            if (aiSection) {
                aiSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Flash effect to highlight the section
                aiSection.style.boxShadow = '0 0 30px rgba(95, 196, 184, 0.6)';
                setTimeout(function() {
                    aiSection.style.boxShadow = '';
                }, 2000);
            }
        }
    </script>
</body>
</html>
